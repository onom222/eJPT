Shellterを使用したAV回避
・防御回避とは、攻撃者が侵入後も検知されないようにするために使用する一連の技術のこと
・防御回避のために使用される技術には、セキュリティソフトウェアのアンインストール/無効化又はデータやスクリプトの難読化/暗号化がある
・攻撃者はまた、信頼されたプロセスを悪用してマルウェアを隠蔽したり、正規の藻に偽装したりすることもある

・AVソフトウェアは通常、シグネチャベース検知、ヒューリスティック検知、および挙動ベース検知を利用する
1) シグネチャーベース検知
AVシグネチャーとは、マルウェアを一意に識別するバイト列のこと
したがって難読化されたエクスプロイトやペイロードが、AVデータベース内の既知のシグネチャーと一致しないようにする必要がある
つまり、シグネチャベース検知は、マルウェアのバイト列を変更することで回避でき、これによりシグネチャ自体を変えることが可能

2) ヒューリスティック検知
ヒューリスティック検知は、バイナリが悪意のあるものかどうかを判断するためにルールや判断基準に基づく手法
また、コード内の特定のパターンやプログラムの呼び出しを調べる

3) 挙動ベース検知
マルウェアの動作を監視して検知する手法

・AV回避の手法
1) 難読化(obfuscation)
難読化とは、重要・価値のある・機密性の高い情報を隠すプロセスのこと
コード再配置・再構成することで解析やリバースエンジニアリングを困難にする。

2) エンコード
データを新しい形式に変換する処理のこと
エンコードは可逆的なプロセスであり、データを別の形式に変換しても元の形式に復号可能

3) パッキング
より小さいサイズのバイナリ構造を生成し、実行ファイルを作り直す手法
これにより、ペイロードに新しいシグネチャーを付与する。

4) クライプター
コードやペイロードを暗号化し、実行時にメモリ上で復号する手法
復号キーや関数は通常、スタブと呼ばれる小さなコード部分に格納される

5) インメモリ回避テクニック
メモリ操作に焦点を当てて、ファイルをディスクに書き込まない。
さまざまなWindowsAPIを利用して、ペイロードをプロセス内にインジェクションする
その後、ペイロードはメモリ内の別スレッドで実行される


powershellによる難読化
・難読化とは、重要・価値のある・機密性の高い情報を隠すプロセスのことを指す
→コードを再配置、再構成することで解析やリバースエンジニアリングを困難にする
・ペンテスターとして活動する際にパワーシェルコードを頻繁に扱うことになる
・ほとんどのAVソリューションは悪意のあるパワーシェルコードを即時に検知するため、検知を回避するためにはパワーシェルコードの難読化/エンコードを行う必要がある

・invoke-obfuscationは、オープンソースのパワーシェつのpowershell v2.0以降対応のコマンドおよびスクリプト難読化ツール


